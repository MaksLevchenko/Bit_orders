<!DOCTYPE html>
<html>
<head>
    <title>–ò–µ—Ä–∞—Ä—Ö–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ - Bitrix24</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .employee-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .employee-row:hover {
            background-color: rgba(13, 110, 253, 0.05) !important;
        }
        .management-chain {
            font-size: 0.85em;
            color: #6c757d;
            line-height: 1.3;
        }
        .call-count {
            font-weight: bold;
            font-size: 1.1em;
        }
        .call-count.high {
            color: #198754;
        }
        .call-count.medium {
            color: #fd7e14;
        }
        .call-count.low {
            color: #6c757d;
        }
        .employee-avatar {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }
        .table th {
            border-top: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h3 mb-2">
                            <i class="fas fa-sitemap text-primary"></i>
                            –ò–µ—Ä–∞—Ä—Ö–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        </h1>
                        <p class="text-muted mb-0">
                            –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–≤–æ–Ω–∫–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group">
                            <a href="{% url 'create_call' %}">
                                <button class="btn btn-outline-primary btn-sm" type="submit">
                                    <i class="fas"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤–æ–Ω–∫–æ–≤
                                </button>
                            </a>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i>
                    –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ({{ total_employees }})
                </h5>
                <span class="badge bg-primary">
                    <i class="fas fa-clock"></i>
                    –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ {% now "d.m.Y H:i" %}
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th width="30%">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                <th width="25%">–î–æ–ª–∂–Ω–æ—Å—Ç—å / –û—Ç–¥–µ–ª</th>
                                <th width="30%">–¶–µ–ø–æ—á–∫–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π</th>
                                <th width="15%" class="text-center">
                                    –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ > 1 –º–∏–Ω
                                    <br>
                                    <small class="fw-normal">(–∑–∞ 24 —á–∞—Å–∞)</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr class="employee-row" data-user-id="{{ employee.ID}}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if employee.photo_url %}
                                            <img src="{{ employee.photo_url }}"
                                                 alt="{{ employee.name }}"
                                                 class="employee-avatar rounded-circle me-3"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        {% endif %}
                                        <div class="bg-secondary rounded-circle me-3 d-flex align-items-center justify-content-center employee-avatar"
                                             style="display: {% if employee.photo_url %}none{% else %}flex{% endif %};">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <strong class="d-block">{{ employee.LAST_NAME }} {{ employee.NAME }}</strong>
                                            {% if employee.EMAIL %}
                                            <small class="text-muted">{{ employee.EMAIL }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ employee.WORK_POSITION|default:"–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞" }}</strong>
                                        {% if employee.DEPARTMENTS %}
                                            {% for dep in employee.DEPARTMENTS %}
                                                <br>
                                                <small class="text-muted">{{ dep }}</small>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="management-chain">
                                        {% if employee.HEADS %}
                                            {% for head in employee.HEADS %}
                                                {{ head }}
                                                <br>
                                            {% endfor %}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% with call_count=employee.OUTGOING_CALLS_24H %}
                                    <span class="call-count
                                        {% if call_count > 5 %}high
                                        {% elif call_count > 0 %}medium
                                        {% else %}low
                                        {% endif %}">
                                        {{ call_count }}
                                    </span>
                                    <br>
                                    <small class="text-muted">–∑–≤–æ–Ω–∫–æ–≤</small>
                                    {% endwith %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <h5>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                                    <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å Bitrix24</p>
                                    <code>python manage.py sync_company_data</code>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h4 text-primary mb-1">
                                        {{ employees|length }}
                                    </div>
                                    <small class="text-muted">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h4 text-success mb-1">
                                        {{ employees_with_calls }}
                                    </div>
                                    <small class="text-muted">–°–æ–≤–µ—Ä—à–∏–ª–∏ –∑–≤–æ–Ω–∫–æ–≤</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-info mb-1">
                                    {{ time_24_hours_ago|date:"d.m.Y H:i" }}
                                </div>
                                <small class="text-muted">–ü–µ—Ä–∏–æ–¥ –æ—Ç—Å—á–µ—Ç–∞</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <ul class="list-unstyled small mb-0">
                            <li><i class="fas fa-mouse-pointer text-primary"></i> –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è</li>
                            <li><i class="fas fa-phone text-success"></i> –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ > 1 –º–∏–Ω—É—Ç—ã</li>
                            <li><i class="fas fa-clock text-info"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bitrix24 —Å–∫—Ä–∏–ø—Ç—ã -->
    {% include 'include/bx24_scripts.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    function refreshData() {
        window.location.reload();
    }

    function showHelp() {
        alert('–ò–ù–°–¢–†–£–ö–¶–ò–Ø:\n\n' +
              '1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å –≤ Bitrix24\n' +
              '2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞\n' +
              '3. –¶–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–≤–æ–Ω–∫–æ–≤:\n' +
              '   üü¢ > 5 –∑–≤–æ–Ω–∫–æ–≤\n' +
              '   üü† 1-5 –∑–≤–æ–Ω–∫–æ–≤\n' +
              '   ‚ö™ 0 –∑–≤–æ–Ω–∫–æ–≤\n\n' +
              '–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:\n' +
              'python manage.py sync_company_data\n' +
              'python manage.py generate_test_calls --days=1');
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    document.addEventListener('DOMContentLoaded', function() {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (window.innerWidth < 768) {
            document.querySelectorAll('.employee-row').forEach(row => {
                row.style.cursor = 'pointer';
                row.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è';
            });
        }
    });
    </script>
</body>
</html>